<div class="user-table-container">
  <nz-card nzTitle="User Management Table" class="table-card">
    <!-- Search and Filters Section -->
    <div class="filters-section">
      <div class="user-count">
        <span class="count-text"
          >Loaded: {{ getCurrentUserCount() }} users</span
        >
      </div>

      <!-- Scrolling Mode Controls -->
      <div class="scroll-controls">
        <div class="control-group">
          <label class="control-label">
            <i nz-icon nzType="deployment-unit" nzTheme="outline"></i>
            Infinite Scroll Mode:
          </label>
          <nz-switch
            [ngModel]="isInfiniteScrollMode"
            (ngModelChange)="toggleScrollMode($event)"
            [nzCheckedChildren]="checkedTemplate"
            [nzUnCheckedChildren]="unCheckedTemplate"
          ></nz-switch>
          <ng-template #checkedTemplate>
            <i nz-icon nzType="check"></i>
          </ng-template>
          <ng-template #unCheckedTemplate>
            <i nz-icon nzType="close"></i>
          </ng-template>
        </div>

        <div class="control-group" *ngIf="isInfiniteScrollMode">
          <label class="control-label">
            <i nz-icon nzType="table" nzTheme="outline"></i>
            Items per page:
          </label>
          <nz-input-number
            [(ngModel)]="pageSize"
            (ngModelChange)="onPageSizeChange($event)"
            [nzMin]="10"
            [nzMax]="500"
            [nzStep]="10"
            class="page-size-input"
          ></nz-input-number>
        </div>
      </div>

      <div class="search-row">
        <nz-input-group [nzSuffix]="suffixIconSearch" class="search-input">
          <input
            type="text"
            nz-input
            placeholder="Search users by name or phone..."
            [(ngModel)]="searchText"
            (input)="onSearchChange()"
          />
        </nz-input-group>
        <ng-template #suffixIconSearch>
          <i nz-icon nzType="search" nzTheme="outline"></i>
        </ng-template>
      </div>

      <div class="filter-row">
        <nz-select
          [(ngModel)]="activeFilter"
          (ngModelChange)="onActiveFilterChange()"
          class="filter-select"
          nzPlaceHolder="Filter by status"
        >
          <nz-option nzValue="all" nzLabel="All Users"></nz-option>
          <nz-option nzValue="active" nzLabel="Active Only"></nz-option>
          <nz-option nzValue="inactive" nzLabel="Inactive Only"></nz-option>
        </nz-select>

        <nz-select
          [(ngModel)]="ageFilter"
          (ngModelChange)="onAgeFilterChange()"
          class="filter-select"
          nzPlaceHolder="Filter by age"
        >
          <nz-option nzValue="all" nzLabel="All Ages"></nz-option>
          <nz-option nzValue="under18" nzLabel="Under 18"></nz-option>
          <nz-option nzValue="over18" nzLabel="18 and Over"></nz-option>
        </nz-select>
      </div>
    </div>

    <!-- Table Section -->
    <div class="table-section" #tableContainer>
      <!-- Initial Loading Spinner -->
      <div *ngIf="initialLoading" class="initial-loading">
        <nz-spin nzSize="large">
          <div class="loading-content">
            <div class="loading-text">Loading users...</div>
            <div class="loading-subtext">Fetching data from server</div>
          </div>
        </nz-spin>
      </div>

      <!-- Virtual Scroll Mode - CDK Virtual Scroll -->
      <div
        *ngIf="!initialLoading && !isInfiniteScrollMode && users.length > 0"
        class="virtual-table"
      >
        <div class="table-header">
          <div class="header-row">
            <div class="header-cell cell-no">No</div>
            <div
              class="header-cell cell-name sortable"
              (click)="onSort('firstName')"
            >
              <span class="header-content">
                First Name
                <i
                  nz-icon
                  [nzType]="getSortIcon('firstName')"
                  nzTheme="outline"
                  class="sort-icon"
                ></i>
              </span>
            </div>
            <div
              class="header-cell cell-name sortable"
              (click)="onSort('lastName')"
            >
              <span class="header-content">
                Last Name
                <i
                  nz-icon
                  [nzType]="getSortIcon('lastName')"
                  nzTheme="outline"
                  class="sort-icon"
                ></i>
              </span>
            </div>
            <div
              class="header-cell cell-dob sortable"
              (click)="onSort('dateOfBirth')"
            >
              <span class="header-content">
                Date of Birth
                <i
                  nz-icon
                  [nzType]="getSortIcon('dateOfBirth')"
                  nzTheme="outline"
                  class="sort-icon"
                ></i>
              </span>
            </div>
            <div class="header-cell cell-phone">Phone Number</div>
            <div class="header-cell cell-status">Status</div>
          </div>
        </div>

        <cdk-virtual-scroll-viewport
          [itemSize]="46"
          [minBufferPx]="200"
          [maxBufferPx]="400"
          class="table-viewport"
        >
          <div
            class="table-row"
            *cdkVirtualFor="
              let user of users;
              let i = index;
              trackBy: trackByUserId
            "
          >
            <div class="table-cell cell-no">{{ i + 1 }}</div>
            <div class="table-cell cell-name">
              <span [innerHTML]="user.firstName | highlight: searchText"></span>
            </div>
            <div class="table-cell cell-name">
              <span [innerHTML]="user.lastName | highlight: searchText"></span>
            </div>
            <div class="table-cell cell-dob">
              {{ formatDate(user.dateOfBirth) }}
            </div>
            <div class="table-cell cell-phone">
              <span
                [innerHTML]="user.phoneNumber | highlight: searchText"
              ></span>
            </div>
            <div class="table-cell cell-status">
              <nz-tag [nzColor]="getActiveStatusColor(user.active)">
                {{ getActiveStatusText(user.active) }}
              </nz-tag>
            </div>
          </div>
        </cdk-virtual-scroll-viewport>
      </div>

      <!-- Infinite Scroll Mode - Regular Table -->
      <nz-table
        *ngIf="!initialLoading && isInfiniteScrollMode && users.length > 0"
        [nzData]="users"
        [nzLoading]="false"
        [nzShowPagination]="false"
        [nzScroll]="{ y: '400px' }"
        nzSize="middle"
      >
        <thead>
          <tr>
            <th>No</th>
            <th
              nzSortKey="firstName"
              (nzSortOrderChange)="onSort('firstName')"
              [nzSortOrder]="
                currentSort.field === 'firstName' ? currentSort.direction : null
              "
              class="sortable-header"
            >
              <span class="header-content">
                First Name
                <i
                  nz-icon
                  [nzType]="getSortIcon('firstName')"
                  nzTheme="outline"
                  class="sort-icon"
                ></i>
              </span>
            </th>
            <th
              nzSortKey="lastName"
              (nzSortOrderChange)="onSort('lastName')"
              [nzSortOrder]="
                currentSort.field === 'lastName' ? currentSort.direction : null
              "
              class="sortable-header"
            >
              <span class="header-content">
                Last Name
                <i
                  nz-icon
                  [nzType]="getSortIcon('lastName')"
                  nzTheme="outline"
                  class="sort-icon"
                ></i>
              </span>
            </th>
            <th
              nzSortKey="dateOfBirth"
              (nzSortOrderChange)="onSort('dateOfBirth')"
              [nzSortOrder]="
                currentSort.field === 'dateOfBirth'
                  ? currentSort.direction
                  : null
              "
              class="sortable-header"
            >
              <span class="header-content">
                Date of Birth
                <i
                  nz-icon
                  [nzType]="getSortIcon('dateOfBirth')"
                  nzTheme="outline"
                  class="sort-icon"
                ></i>
              </span>
            </th>
            <th>Phone Number</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users; trackBy: trackByUserId; let i = index">
            <td>{{ i + 1 }}</td>
            <td>
              <span [innerHTML]="user.firstName | highlight: searchText"></span>
            </td>
            <td>
              <span [innerHTML]="user.lastName | highlight: searchText"></span>
            </td>
            <td>{{ formatDate(user.dateOfBirth) }}</td>
            <td>
              <span
                [innerHTML]="user.phoneNumber | highlight: searchText"
              ></span>
            </td>
            <td>
              <nz-tag [nzColor]="getActiveStatusColor(user.active)">
                {{ getActiveStatusText(user.active) }}
              </nz-tag>
            </td>
          </tr>
        </tbody>
      </nz-table>

      <!-- Loading overlay for sort/search/filter operations -->
      <div
        *ngIf="!initialLoading && loading && !isLoadingMore"
        class="loading-overlay"
        [style.opacity]="0.9"
      >
        <nz-spin nzSize="default">
          <div class="loading-content">
            <div class="loading-text">Updating results...</div>
          </div>
        </nz-spin>
      </div>

      <!-- Loading indicator for infinite scroll - Fixed overlay -->
      <div
        *ngIf="isInfiniteScrollMode && isLoadingMore && hasMoreData"
        class="scroll-loading-overlay"
      >
        <nz-spin nzSize="small">
          <div class="loading-content">
            <div class="loading-text">Loading more...</div>
          </div>
        </nz-spin>
      </div>

      <!-- End of list indicator - Fixed overlay -->
      <div
        *ngIf="
          isInfiniteScrollMode && !hasMoreData && !loading && users.length > 0
        "
        class="end-of-list-overlay"
      >
        <i nz-icon nzType="check-circle" nzTheme="outline"></i>
        <span>All data loaded</span>
      </div>

      <!-- Empty state -->
      <nz-empty
        *ngIf="
          !initialLoading && !loading && users.length === 0 && hasDataLoaded
        "
        nzNotFoundContent="No users found"
        [nzNotFoundImage]="'/empty.svg'"
      ></nz-empty>
    </div>
  </nz-card>
</div>
